---
title: "Exploratorio"
author: "Esteban Ruc√°n"
date: "31-10-2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center')
require(tidyverse)
require(roperators)
```

```{r FUNCIONES}
auto_drop1 <- function(data_frame, v_respuesta, v_explicativas, alpha) {
    formula <- as.formula(
            paste(v_respuesta, paste(v_explicativas, collapse = "+"),
            sep = " ~ "))

    full_lin_mod <- lm(formula = formula, data = data_frame)
    detencion <- FALSE

    while(detencion == FALSE) {

        drop_1 <- drop1(full_lin_mod, test = "Chisq")
        maximo <- drop_1$`Pr(>Chi)`[!is.na(drop_1$`Pr(>Chi)`)] %>% max()
        indice <- which(drop_1$`Pr(>Chi)`== maximo) - 1

        if(maximo >= alpha) {

            v_explicativas <- v_explicativas[-indice]
            actualizacion <- as.formula(
                paste("~ ", paste(v_explicativas, collapse = "+"), sep = ""))
            full_lin_mod <- update(full_lin_mod, actualizacion)

        } else {
            detencion <- TRUE
        }
    }

    return(list(modelo = full_lin_mod, aic = min(drop_1$AIC)))
}

auto_add1 <- function(data_frame, v_respuesta, v_explicativas, alpha) {
    formula <- as.formula(paste(v_respuesta, "1", sep = " ~ "))
    scope <- as.formula(
        paste("~ ", paste(v_explicativas, collapse = "+"), sep = ""))
    null_lin_mod <- lm(formula = formula, data = data_frame)
    detencion <- FALSE
    variables <- c()

    while(detencion == FALSE) {

        add_1 <- add1(null_lin_mod, scope = scope, test = "Chisq")
        minimo <- add_1$`Pr(>Chi)`[!is.na(add_1$`Pr(>Chi)`)] %>% min()
        indice <- which(add_1$`Pr(>Chi)`== minimo) - 1

        if(minimo <= alpha) {
            variables <- c(variables, v_explicativas[indice])
            v_explicativas <- v_explicativas[-indice]
            actualizacion <- as.formula(
                paste("~ ", paste(variables, collapse = "+"), sep = ""))
            null_lin_mod <- update(null_lin_mod, actualizacion)

        } else {
            detencion <- TRUE
        }
    }

    return(list(modelo = null_lin_mod, aic = min(add_1$AIC)))
}

supuestos <- function(modelo) {
    dw <- modelo %>% lmtest::dwtest()
    independencia <- abs(dw$statistic - 2) <= 0.5
    
    ks <- modelo %>% rstandard() %>% ks.test("pnorm") 
    normalidad <- ks$p.value >= 0.05
    
    bp <- modelo %>% lmtest::bptest()
    homocedasticidad <- bp$p.value >= 0.05
    
    return(c(independencia, normalidad, homocedasticidad))
}

auto_vif <- function(data_frame, v_respuesta, v_explicativas, criterio = 10) {
    
    data_frame <- data
    v_respuesta <- "critical_temp"
    v_explicativas <- variables
    formula <- as.formula(
            paste(v_respuesta, paste(v_explicativas, collapse = "+"),
            sep = " ~ "))

    full_lin_mod <- lm(formula = formula, data = data_frame)
    detencion <- FALSE

    while(detencion == FALSE) {

        vifs <- car::vif(full_lin_mod)
        maximo <- vifs %>% max()
        indice <- which(vifs == maximo)

        if(maximo >= criterio) {

            v_explicativas <- v_explicativas[-indice]
            actualizacion <- as.formula(
                paste("~ ", paste(v_explicativas, collapse = "+"), sep = ""))
            full_lin_mod <- update(full_lin_mod, actualizacion)

        } else {
            detencion <- TRUE
        }
    }

    return(list(modelo = full_lin_mod, aic = -2 * logLik(full_lin_mod) + 2 * (length(coefficients(full_lin_mod)) + 1)))
}

eliminar_multicolinealidad <- function(modelo, criterio) {
    v_explicativas <- names(modelo$coefficients)[-1]
    detencion <- FALSE
    
    while(detencion == FALSE) {
        vifs <- car::vif(modelo)
        maximo <- vifs %>% max()
        indice <- which(vifs == maximo)

        if(maximo >= criterio) {

            v_explicativas <- v_explicativas[-indice]
            actualizacion <- as.formula(
                paste("~ ", paste(v_explicativas, collapse = "+"), sep = ""))
            modelo <- update(modelo, actualizacion, data = data)

        } else {
            detencion <- TRUE
        }
    }
    
    return(list(modelo = modelo, aic = -2 * as.numeric(logLik(modelo)) + 2 * (length(coefficients(modelo)) + 1)))
        
}
    

```



```{r BASE}
data <- rio::import("datos/clean_db.csv")[2:35]
data$number_of_elements <- NULL
variables <- names(data)[1:32][-25]
formula <- "critical_temp ~ " %+% paste(variables, collapse = "+") %>% as.formula()
```

```{r MODELOS}
full_mod <- lm(formula = formula, data = data)
null_mod <- lm(formula = critical_temp ~ 1, data = data)

# bw
backward <- step(full_mod, direction = "backward", trace = 0)
(aic_backward <- backward$anova$AIC %>% min())
(variables_backward <- backward %>% coefficients() %>% length())
(supuestos_backward <- backward %>% supuestos())
(summary(backward)$r.squared)

# fw
forward <- step(full_mod, direction = "forward", scope = formula, trace = 0)
(aic_forward <- forward$anova$AIC %>% min())
(variables_forward <- forward %>% coefficients() %>% length())
(supuestos_forward <- forward %>% supuestos())
(summary(forward)$r.squared)

# stepwise
stepwise <- step(full_mod, direction = "both", trace = 0)
(aic_stepwise <- stepwise$anova$AIC %>% min())
(variables_stepwise <- stepwise %>% coefficients() %>% length())
(supuestos_stepwise <- stepwise %>% supuestos())
(summary(stepwise)$r.squared)

# drop1
drop1 <- auto_drop1(data, "critical_temp", variables, 0.05)
(aic_drop1 <- drop1$aic)
(variables_drop1 <- drop1$modelo %>% coefficients() %>% length())
(supuestos_drop1 <- drop1$modelo %>% supuestos())
(summary(drop1$modelo)$r.squared)

# add1
add1 <- auto_add1(data, "critical_temp", variables, 0.05)
(aic_add1 <- add1$aic)
(variables_add1 <- add1$modelo %>% coefficients() %>% length())
(supuestos_add1 <- add1$modelo %>% supuestos())
(summary(add1$modelo)$r.squared)

add1_1 <- eliminar_multicolinealidad(add1$modelo, 10)

car::vif(add1_1$modelo)
add1_1$aic

# Vif
mod_vif <- auto_vif(data, "critical_temp", variables, 7)
(aic_vif <- mod_vif$aic)
(variables_vif <- mod_vif$modelo %>% coefficients() %>% length())
(supuestos_vif <- mod_vif$modelo %>% supuestos())
(summary(mod_vif$modelo)$r.squared)

```




```{r RIDGE REGRESSION}
data_ridge <- data
data_ridge$range_Valence <- NULL
x_vars <- model.matrix(critical_temp~. , data_ridge)[,-1]
y_var <- data_ridge$critical_temp
lambda_seq <- 10^seq(-2, 5, by = 0.001)

#set.seed(86)
#train = sample(1:nrow(x_vars), 0.9 * nrow(x_vars))
#x_test = (-train)
#y_test = y_var[x_test]

cv_output <- glmnet::cv.glmnet(x_vars, y_var,
                       alpha = 0, lambda = lambda_seq, 
                       nfolds = 10)
 
# identifying best lambda
best_lam <- cv_output$lambda.min
best_lam

# Rebuilding the model with best lamda value identified
ridge_best <- glmnet::glmnet(x_vars, y_var, alpha = 0, lambda = best_lam)
pred <- predict(ridge_best, s = best_lam, newx = x_vars)

final <- cbind(y_var, pred)

head(final)


actual <- y_var
preds <- pred
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq <- 1 - rss/tss
rsq




```


```{r LASSO REGRESSION}
data_ridge <- data
data_ridge$range_Valence <- NULL
x_vars <- model.matrix(critical_temp~. , data_ridge)[,-1]
y_var <- data_ridge$critical_temp
lambda_seq <- 10^seq(-2, 10, by = 0.1)

set.seed(86)
train = sample(1:nrow(x_vars), 0.5 * nrow(x_vars))
x_test = (-train)
y_test = y_var[x_test]

cv_output <- glmnet::cv.glmnet(x_vars[train,], y_var[train],
                       alpha = 1, lambda = lambda_seq, 
                       nfolds = 10)


 
# identifying best lambda
best_lam <- cv_output$lambda.min
best_lam

# Rebuilding the model with best lamda value identified
lasso_best <- glmnet::glmnet(x_vars[train,], y_var[train], alpha = 1, lambda = best_lam)
pred <- predict(lasso_best, s = best_lam, newx = x_vars[x_test,])

final <- cbind(y_var[-train], pred)

head(final)


actual <- y_var[-train]
preds <- pred
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq <- 1 - rss/tss
rsq


plot(actual ~ preds)
```

```{r results="hide"}
data$number_of_elements <- NULL

lin_mods_bw <- list()
lin_mods_fw <- list()
lin_mods_bf <- list()
vr <- c()
fitted_values_bw <- c()
fitted_values_fw <- c()
fitted_values_bf <- c()

for(i in 0:6){
    new_data <- data %>% 
        filter(range_Valence == i)
    new_data$range_Valence <- NULL
    
    variables_var_minima <- caret::nearZeroVar(new_data, names = TRUE)
    
    for(variable in variables_var_minima){
        new_data[[variable]] <- NULL
    }
    
    full_lin_mod_i <- lm(critical_temp ~ ., data = new_data)
    null_lin_mod_i <- lm(critical_temp ~ 1, data = new_data)
    
    if(summary(full_lin_mod_i)$r.squared != 1){
        lin_mods_bw[[paste(i)]] <- step(full_lin_mod_i, direction = "backward", trace = 0)
        lin_mods_fw[[paste(i)]] <- step(null_lin_mod_i, direction = "forward", scope = formula(full_lin_mod_i), trace = 0)
        lin_mods_bf[[paste(i)]] <- step(full_lin_mod_i, direction = "both", trace = 0)
    } else{
        lin_mods_bw[[paste(i)]] <- full_lin_mod_i
        lin_mods_fw[[paste(i)]] <- full_lin_mod_i
        lin_mods_bf[[paste(i)]] <- full_lin_mod_i
    }
    
    vr <- c(vr, new_data$critical_temp)
    fitted_values_bw <- c(fitted_values_bw, lin_mods_bw[[paste(i)]]$fitted.values)
    fitted_values_fw <- c(fitted_values_fw, lin_mods_fw[[paste(i)]]$fitted.values)
    fitted_values_bf <- c(fitted_values_bf, lin_mods_bf[[paste(i)]]$fitted.values)
}

(correlacion_bw <- cor(vr, fitted_values_bw))
(correlacion_fw <- cor(vr, fitted_values_fw))
(correlacion_bf <- cor(vr, fitted_values_bf))

plot(vr ~ fitted_values_bw)

newmod <- lm(vr ~ fitted_values_fw)

plot(density(vr), col = "red")
lines(density(fitted_values_bw))


```

