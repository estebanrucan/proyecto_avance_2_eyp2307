---
title: "Exploratorio"
author: "Esteban Ruc√°n"
date: "31-10-2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.align = 'center')
library(caret)
library(tidyverse)
```

```{r}
train = rio::import("train.csv")
unique_m = rio::import("unique_m.csv")
train$critical_temp = NULL
unique_m$material = NULL
df = data.frame(train, unique_m)
variables = names(df)
cantvariables = length(variables)
variables_baja_var = caret::nearZeroVar(df, names = TRUE)
for(i in 1:(length(variables_baja_var))){
    a = paste("df$",variables_baja_var[i],"=NULL",sep = "")
    eval(parse( text=a ))
}
variables = names(df)
cantvariables = length(variables)
tol = 0.05
cor_baja = c()
for(i in 1:(cantvariables-1)){
    correlacion = cor(df[,i], df$critical_temp)
    if(abs(correlacion) < tol){
        cor_baja = c(cor_baja, i)
    }
}
variables_cor_baja = c()
for(i in 1:(length(cor_baja))){
    variables_cor_baja = c(variables_cor_baja, variables[cor_baja[i]])
}
for(i in 1:(length(variables_cor_baja))){
    a = paste("df$",variables_cor_baja[i],"=NULL",sep = "")
    eval(parse( text=a ))
}
variables = names(df)
cantvariables = length(variables)
tol = 0.8
cor_alta = c()
for( i in 1:(cantvariables-1)){
    if(i != cantvariables-1){
        for(j in (i+1):(cantvariables-1)){
            correlacion = cor(df[,i], df[,j])
            if(abs(correlacion) > tol){
                cor_alta = c(cor_alta,j)
            }
        }
    }
}
cor_alta = sort(cor_alta[!duplicated(cor_alta)])
variables_cor_alta = c()
for(i in 1:(length(cor_alta))){
    variables_cor_alta = c(variables_cor_alta, variables[cor_alta[i]])
}
for(i in 1:(length(variables_cor_alta))){
    a = paste("df$",variables_cor_alta[i],"=NULL",sep = "")
    eval(parse( text=a ))
}
variables = names(df)
cantvariables = length(variables)
df = df[!duplicated(df),]
rm(list=ls()[-6])
#corrplot1 = cor(df)[, 'critical_temp'][-34] %>% abs() %>% sort() 
```

```{r NORMALIDAD VARIABLE RESPUESTA}
set.seed(19)
df_shapiro <- df[sample(1:nrow(df), 5000), ]
qqnorm(df_shapiro$critical_temp); qqline(df_shapiro$critical_temp)
shapiro.test(df_shapiro$critical_temp)
lambda <- EnvStats::boxcox(df_shapiro$critical_temp, optimize=TRUE)$lambda

if(lambda==0){ df_shapiro$critical_temp <- log(df_shapiro$critical_temp)
} else { df_shapiro$critical_temp <- (df_shapiro$critical_temp ^ lambda-1)/lambda }
qqnorm(df_shapiro$critical_temp); qqline(df_shapiro$critical_temp)
shapiro.test(df_shapiro$critical_temp)

set.seed(19)
df_shapiro <- df[sample(1:nrow(df), 5000), ]
df_shapiro$critical_temp <- Johnson::RE.Johnson(df_shapiro$critical_temp)$transformed
qqnorm(df_shapiro$critical_temp); qqline(df_shapiro$critical_temp)
shapiro.test(df_shapiro$critical_temp)
```




```{r RIDGE REGRESSION}
x <- df[, 1:33]; y <- df[, 34] %>% as.data.frame()

set.seed(1)
train_rows <- sample(1:nrow(x), nrow(x) * 2 / 3)
train_df <- df[train_rows, ]
x_train <- x[train_rows, ] %>% as.matrix()
x_test <- x[-train_rows, ] %>% as.matrix()
y_train <- y[train_rows, ] %>% as.matrix()
y_test <- y[-train_rows, ] %>% as.matrix()


ridge_fit <- lmridge::lmridge(critical_temp ~ ., data = train_df)

ridge_predicted <- predict(ridge_fit, s = ridge_fit$lambda.min, newx = x_test) %>%
    as.numeric()


```


```{r results="hide"}
df$number_of_elements <- NULL
df$range_Valence <- factor(df$range_Valence)

lin_mods_bw <- list()
lin_mods_fw <- list()
lin_mods_bf <- list()
vr <- c()
fitted_values_bw <- c()
fitted_values_fw <- c()
fitted_values_bf <- c()

for(i in 0:6){
    new_df <- df %>% 
        filter(range_Valence == i)
    new_df$range_Valence <- NULL
    
    variables_var_minima <- caret::nearZeroVar(new_df, names = TRUE)
    
    for(variable in variables_var_minima){
        new_df[[variable]] <- NULL
    }
    
    full_lin_mod_i <- lm(critical_temp ~ ., data = new_df)
    null_lin_mod_i <- lm(critical_temp ~ 1, data = new_df)
    
    if(summary(full_lin_mod_i)$r.squared != 1){
        lin_mods_bw[[paste(i)]] <- step(full_lin_mod_i, direction = "backward", trace = 0)
        lin_mods_fw[[paste(i)]] <- step(null_lin_mod_i, direction = "forward", scope = formula(full_lin_mod_i), trace = 0)
        lin_mods_bf[[paste(i)]] <- step(full_lin_mod_i, direction = "both", trace = 0)
    } else{
        lin_mods_bw[[paste(i)]] <- full_lin_mod_i
        lin_mods_fw[[paste(i)]] <- full_lin_mod_i
        lin_mods_bf[[paste(i)]] <- full_lin_mod_i
    }
    
    vr <- c(vr, new_df$critical_temp)
    fitted_values_bw <- c(fitted_values_bw, lin_mods_bw[[paste(i)]]$fitted.values)
    fitted_values_fw <- c(fitted_values_fw, lin_mods_fw[[paste(i)]]$fitted.values)
    fitted_values_bf <- c(fitted_values_bf, lin_mods_bf[[paste(i)]]$fitted.values)
}

(correlacion_bw <- cor(vr, fitted_values_bw))
(correlacion_fw <- cor(vr, fitted_values_fw))
(correlacion_bf <- cor(vr, fitted_values_bf))

new_mod <- lm(vr ~ fitted_values_bw)


r_squared <- summary(new_mod)$r.squared
aic <- AIC(new_mod)
bic <- BIC(new_mod)




```

